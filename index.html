<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Memoria Visual - Cl√≠nica Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a0f1d; --pink: #ff2e63; --blue: #08d9d6; --card: #16213e; }
        body { margin: 0; font-family: 'Montserrat'; background: var(--bg); color: white; overflow: hidden; height: 100vh; }
        
        /* Barra Admin */
        #admin-bar { display: none; background: var(--blue); color: #0a0f1d; padding: 10px 20px; justify-content: space-between; align-items: center; font-weight: bold; position: fixed; top: 0; width: 100%; z-index: 3000; box-sizing: border-box; }
        .btn-view { background: #0a0f1d; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .header { height: 70px; background: #1a1a2e; display: flex; justify-content: space-around; align-items: center; border-bottom: 5px solid var(--pink); }
        .stat b { display: block; color: var(--blue); font-size: 0.7rem; }
        
        #game-area { height: calc(100vh - 70px); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .tile { 
            width: 90px; height: 90px; background: var(--card); border-radius: 20px; 
            display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
            cursor: pointer; border: 4px solid transparent; transition: 0.2s; user-select: none;
        }
        .tile.active { background: var(--blue); transform: scale(1.1); border-color: white; box-shadow: 0 0 30px var(--blue); }

        .overlay { position: fixed; inset: 0; background: rgba(10, 15, 29, 0.98); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .card { background: white; color: #2d3436; border-radius: 40px; padding: 35px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 15px 0 var(--blue); position: relative; }
        .btn { background: var(--pink); color: white; padding: 18px; border-radius: 20px; font-weight: 900; border: none; cursor: pointer; width: 100%; font-size: 1.2rem; margin-top: 15px; }
        
        .habilidades { text-align: left; background: #f1f2f6; padding: 15px; border-radius: 15px; margin: 15px 0; font-size: 0.8rem; color: #555; }
        #msg-guia { font-size: 1.5rem; font-weight: 900; color: var(--blue); margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="admin-bar">
    <span>MODO PROFESIONAL: MEMORIA</span>
    <button class="btn-view" onclick="window.open('https://docs.google.com/spreadsheets/d/1Tm068QA9fWLAmnrqYgIqDdcl211OZkyIpcd0/edit', '_blank')">üìä VER EXCEL</button>
</div>

<div id="screen-start" class="overlay">
    <div class="card">
        <button style="position:absolute; top:20px; right:20px; background:none; border:none; opacity:0.3;" onclick="activarAdmin()">‚öôÔ∏è</button>
        <h2 id="msg-bienvenida" style="color:var(--bg)">Cargando...</h2>
        <div class="habilidades">
            <b>HABILIDADES:</b><br>
            ‚Ä¢ Memoria Visual Secuencial<br>
            ‚Ä¢ Atenci√≥n Sostenida<br>
            ‚Ä¢ Procesamiento de Informaci√≥n
        </div>
        <button class="btn" onclick="startGame()">EMPEZAR</button>
    </div>
</div>

<div id="screen-end" class="overlay" style="display:none">
    <div class="card">
        <h1 style="color:var(--pink)">SESI√ìN FINALIZADA</h1>
        <div id="status-envio" style="margin:20px 0; font-weight:bold; color:#009955;">üì§ Sincronizando...</div>
        <button class="btn" onclick="window.location.href='index.html'">VOLVER AL MEN√ö</button>
    </div>
</div>

<div class="header">
    <div class="stat"><b>NIVEL</b><span id="txt-nivel">1</span></div>
    <div class="stat"><b>ACIERTOS</b><span id="txt-ok">0</span></div>
    <div class="stat"><b>VIDAS</b><span id="txt-vidas" style="color:var(--pink)">3</span></div>
</div>

<div id="game-area">
    <div id="msg-guia">¬°ATENCI√ìN!</div>
    <div class="grid" id="grid-elementos"></div>
</div>

<script>
    // 1. CAPTURAR DATOS DEL PORTAL
    const paciente = localStorage.getItem('paciente') || "Paciente";
    const profesional = localStorage.getItem('profesional') || "Doc";
    document.getElementById('msg-bienvenida').innerText = "Hola, " + paciente;

    let nivel = 1, vidas = 3, totalAciertos = 0, secuencia = [], secuenciaUsuario = [], mostrando = false;
    const iconos = ["‚≠ê", "üçé", "üéà", "üöó", "üê∂", "üçï", "üöÄ", "üé∏", "üíé"];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playTone(freq) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    function activarAdmin() { if(prompt("Clave:") === "1234") document.getElementById('admin-bar').style.display = 'flex'; }

    function startGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        document.getElementById('screen-start').style.display = 'none';
        crearTablero();
        iniciarRonda();
    }

    function crearTablero() {
        const grid = document.getElementById('grid-elementos');
        grid.innerHTML = "";
        iconos.forEach((icono, index) => {
            const tile = document.createElement('div');
            tile.className = "tile";
            tile.innerText = icono;
            tile.onclick = () => manejarClick(index);
            grid.appendChild(tile);
        });
    }

    function iniciarRonda() {
        mostrando = true;
        secuenciaUsuario = [];
        document.getElementById('msg-guia').innerText = "¬°MIRA!";
        document.getElementById('txt-nivel').innerText = nivel;
        document.getElementById('txt-vidas').innerText = vidas;
        
        secuencia = [];
        for(let i=0; i < (1 + nivel); i++) {
            secuencia.push(Math.floor(Math.random() * 9));
        }
        setTimeout(reproducirSecuencia, 800);
    }

    async function reproducirSecuencia() {
        const tiles = document.getElementsByClassName('tile');
        for(let i=0; i < secuencia.length; i++) {
            await new Promise(r => setTimeout(r, 600));
            const idx = secuencia[i];
            tiles[idx].classList.add('active');
            playTone(400 + (idx * 40));
            await new Promise(r => setTimeout(r, 400));
            tiles[idx].classList.remove('active');
        }
        mostrando = false;
        document.getElementById('msg-guia').innerText = "¬°REPITE!";
    }

    function manejarClick(index) {
        if(mostrando) return;
        const tiles = document.getElementsByClassName('tile');
        if(index === secuencia[secuenciaUsuario.length]) {
            playTone(500 + (index * 40));
            tiles[index].classList.add('active');
            setTimeout(() => tiles[index].classList.remove('active'), 200);
            secuenciaUsuario.push(index);
            if(secuenciaUsuario.length === secuencia.length) {
                totalAciertos++;
                document.getElementById('txt-ok').innerText = totalAciertos;
                nivel++;
                setTimeout(iniciarRonda, 1000);
            }
        } else {
            vidas--;
            if(vidas <= 0) finalizarJuego();
            else iniciarRonda();
        }
    }

    function finalizarJuego() {
        document.getElementById('screen-end').style.display = 'flex';
        enviarDatosFinales();
    }

    // 2. ENVIAR AL EXCEL COMPARTIDO
    function enviarDatosFinales() {
        const formAction = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const form = document.createElement("form");
        form.method = "POST"; form.action = formAction; form.target = "hidden_iframe";

        const datos = {
            "entry.369874016": paciente,
            "entry.1353470174": "Memoria Visual (Prof: " + profesional + ")",
            "entry.721051298": nivel,
            "entry.873272199": totalAciertos,
            "entry.1030094511": "N/A",
            "entry.1303309812": "Finalizado",
            "entry.845098414": new Date().toISOString().split('T')[0]
        };

        for (let key in datos) {
            const input = document.createElement("input");
            input.type = "hidden"; input.name = key; input.value = datos[key];
            form.appendChild(input);
        }

        const iframe = document.createElement("iframe");
        iframe.name = "hidden_iframe"; iframe.style.display = "none";
        document.body.appendChild(iframe); document.body.appendChild(form);
        form.submit();
        setTimeout(() => { document.getElementById('status-envio').innerText = "‚úÖ DATOS EN EXCEL"; }, 2000);
    }
</script>
</body>
</html>

