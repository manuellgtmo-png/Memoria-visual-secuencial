<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terapia Visual Pro - Secuencial</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #3498db; --success: #27ae60; --error: #e74c3c; --bg: #f0f3f5; --text: #2c3e50; --contrast: 1; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; touch-action: manipulation; }
        
        #game-container { 
            width: 100%; max-width: 600px; background: white; padding: 20px; 
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            position: relative; overflow: hidden; min-height: 500px;
        }

        /* Pantalla de IntroducciÃ³n */
        #intro-screen { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: white; z-index: 100; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 30px; 
            box-sizing: border-box; border-radius: 20px; 
        }
        
        /* Grilla DinÃ¡mica */
        .grid { display: grid; gap: 15px; margin: 20px 0; transition: 0.3s; }
        .grid-2x2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3x2 { grid-template-columns: repeat(3, 1fr); }
        .grid-3x3 { grid-template-columns: repeat(3, 1fr); }

        .shape { 
            aspect-ratio: 1/1; border-radius: 15px; cursor: pointer; border: 4px solid transparent; 
            transition: transform 0.1s, opacity 0.1s;
            filter: saturate(var(--contrast)) brightness(var(--contrast));
            -webkit-tap-highlight-color: transparent; /* Elimina cuadro azul en mÃ³viles */
        }
        .active { transform: scale(0.9); border-color: #333 !important; opacity: 0.7; }

        /* Colores y Formas */
        .circle { background: #ff5f5f; border-radius: 50%; }
        .square { background: #5fafff; }
        .triangle { background: #5fff7f; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .diamond { background: #ffef5f; transform: rotate(45deg) scale(0.8); }
        .pentagon { background: #a55eea; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }
        .hexagon { background: #fd9644; clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); }
        .star { background: #f7b731; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .cross { background: #eb3b5a; clip-path: polygon(20% 0%, 80% 0%, 80% 20%, 100% 20%, 100% 80%, 80% 80%, 80% 100%, 20% 100%, 20% 80%, 0% 80%, 0% 20%, 20% 20%); }
        .trapezoid { background: #2bcbba; clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%); }

        .controls-box { background: #f8f9fa; padding: 15px; border-radius: 12px; margin: 15px 0; border: 1px solid #eee; }
        label { display: block; font-size: 0.85em; font-weight: bold; margin-bottom: 5px; color: #7f8c8d; }

        #pro-section { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; display: none; text-align: left; }
        .lock-btn { background: none; border: none; color: #bdc3c7; cursor: pointer; font-size: 0.8em; margin-top: 20px; width: 100%; }
        
        button { padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; margin-top: 10px; }
        
        #timer-bar { height: 10px; background: var(--error); width: 0%; border-radius: 5px; margin-bottom: 15px; }
        #msg { font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="intro-screen">
        <h2 style="color:var(--primary); margin-bottom: 10px;">Â¡Hola! Vamos a trabajar...</h2>
        <p style="text-align: center; line-height: 1.6; font-size: 1.1em; color: #34495e;">
            Tu memoria y atenciÃ³n visual son la clave hoy. 
            Observa con cuidado las figuras que se iluminan y trata de recordar su orden exacto. 
            Â¡Cada nivel serÃ¡ un nuevo reto con mÃ¡s figuras! 
            <br><br><strong>Â¿EstÃ¡s listo?</strong>
        </p>
        <button class="btn-blue" onclick="closeIntro()">Â¡SÃ­, estoy listo!</button>
    </div>

    <input type="text" id="p-name" placeholder="Nombre del Paciente">
    
    <div class="controls-box">
        <label>Tiempo de memorizaciÃ³n: <span id="s-val">1.0s</span></label>
        <input type="range" id="s-range" min="0.5" max="10" step="0.5" value="1" oninput="updateUI()">
        
        <label style="margin-top:10px;">Nivel de Contraste: <span id="c-val">100%</span></label>
        <input type="range" id="c-range" min="0.2" max="1" step="0.1" value="1" oninput="updateUI()">
    </div>

    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="font-size: 1.2em; font-weight: bold;">Nivel: <span id="lv">1</span></span>
        <span id="msg">Â¡Bienvenido!</span>
    </div>

    <div id="timer-bar"></div>
    <div id="game-grid" class="grid grid-2x2"></div>

    <button id="start-btn" class="btn-blue" onclick="init()">Iniciar Entrenamiento</button>
    <button id="next-btn" class="btn-green" style="display:none" onclick="playLevel()">Siguiente Nivel âž”</button>

    <button class="lock-btn" onclick="unlockPro()">ðŸ”“ Acceso Profesional</button>
    
    <div id="pro-section">
        <h3>Historial ClÃ­nico</h3>
        <input type="text" id="search" placeholder="Buscar paciente..." oninput="drawAll()">
        <div style="height:220px;"><canvas id="myChart"></canvas></div>
        <table style="width:100%; border-collapse: collapse; margin-top:15px; font-size:0.85em;">
            <thead style="background:#eee;"><tr><th>Fecha</th><th>Paciente</th><th>Nivel</th></tr></thead>
            <tbody id="h-body"></tbody>
        </table>
        <button onclick="downloadCSV()" style="font-size:11px; margin-top:15px; background:#95a5a6; color:white;">Descargar Excel</button>
    </div>
</div>

<script>
    let seq = [], uSeq = [], lv = 1, can = false, chart;
    const allShapes = ['circle', 'square', 'triangle', 'diamond', 'pentagon', 'hexagon', 'star', 'cross', 'trapezoid'];
    const pass = "1234";

    function closeIntro() { document.getElementById('intro-screen').style.display = 'none'; }

    function updateUI() {
        document.getElementById('s-val').innerText = document.getElementById('s-range').value + "s";
        const c = document.getElementById('c-range').value;
        document.getElementById('c-val').innerText = (c*100).toFixed(0) + "%";
        document.documentElement.style.setProperty('--contrast', c);
    }

    function renderGrid() {
        const g = document.getElementById('game-grid');
        g.innerHTML = "";
        let count = (lv >= 11) ? 9 : (lv >= 6 ? 6 : 4);
        g.className = "grid " + (lv >= 11 ? "grid-3x3" : (lv >= 6 ? "grid-3x2" : "grid-2x2"));

        for(let i=0; i<count; i++) {
            const d = document.createElement('div');
            const shapeId = allShapes[i];
            d.className = `shape ${shapeId}`;
            d.id = shapeId;
            
            // SOPORTE TOUCH Y MOUSE
            const handleAction = (e) => {
                e.preventDefault();
                handleUser(shapeId);
            };
            d.addEventListener('touchstart', handleAction, {passive: false});
            d.addEventListener('mousedown', (e) => {
                if ('ontouchstart' in window) return; // Evita doble disparo en mÃ³viles
                handleUser(shapeId);
            });
            
            g.appendChild(d);
        }
    }

    function init() {
        if(!document.getElementById('p-name').value) return alert("Nombre requerido");
        lv = 1; seq = [];
        document.getElementById('start-btn').style.display = 'none';
        playLevel();
    }

    async function playLevel() {
        uSeq = []; can = false;
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('lv').innerText = lv;
        renderGrid();
        const visibleCount = (lv >= 11) ? 9 : (lv >= 6 ? 6 : 4);
        seq.push(allShapes[Math.floor(Math.random() * visibleCount)]);
        await new Promise(r => setTimeout(r, 600));
        const speed = document.getElementById('s-range').value * 1000;
        for(let s of seq) {
            document.getElementById('msg').innerText = "Memoriza...";
            await flash(s, speed);
        }
        document.getElementById('msg').innerText = "Â¡Tu turno!";
        can = true;
    }

    function flash(id, ms) {
        return new Promise(r => {
            const el = document.getElementById(id);
            const bar = document.getElementById('timer-bar');
            bar.style.transition = 'none'; bar.style.width = '100%';
            void bar.offsetWidth;
            el.classList.add('active');
            bar.style.transition = `width ${ms}ms linear`; bar.style.width = '0%';
            setTimeout(() => { el.classList.remove('active'); setTimeout(r, 250); }, ms);
        });
    }

    function handleUser(id) {
        if(!can) return;
        uSeq.push(id);
        const el = document.getElementById(id);
        el.classList.add('active'); 
        setTimeout(() => el.classList.remove('active'), 100);

        if(uSeq[uSeq.length-1] !== seq[uSeq.length-1]) {
            save();
            document.getElementById('msg').innerText = "Â¡Error!";
            alert("Nivel final: " + (lv-1));
            lv = 1; seq = [];
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('start-btn').innerText = "Reintentar";
            can = false;
            return;
        }
        if(uSeq.length === seq.length) {
            document.getElementById('msg').innerText = "Â¡Muy bien!";
            lv++; can = false;
            document.getElementById('next-btn').style.display = 'block';
        }
    }

    function save() {
        const rec = { n: document.getElementById('p-name').value, d: new Date().toLocaleString(), l: lv-1 };
        let h = JSON.parse(localStorage.getItem('h')) || [];
        h.unshift(rec);
        localStorage.setItem('h', JSON.stringify(h));
        drawAll();
    }

    function unlockPro() {
        if(prompt("Clave:") === pass) {
            document.getElementById('pro-section').style.display = 'block';
            drawAll();
        }
    }

    function drawAll() {
        const h = JSON.parse(localStorage.getItem('h')) || [];
        const f = document.getElementById('search').value.toLowerCase();
        const filtered = h.filter(x => x.n.toLowerCase().includes(f));
        const b = document.getElementById('h-body');
        b.innerHTML = "";
        filtered.slice(0,10).forEach(x => {
            b.innerHTML += `<tr style="border-bottom:1px solid #eee"><td>${x.d.split(' ')[0]}</td><td>${x.n}</td><td>${x.l}</td></tr>`;
        });
        const chartData = [...filtered].reverse();
        if(chart) chart.destroy();
        chart = new Chart(document.getElementById('myChart'), {
            type: 'line',
            data: {
                labels: chartData.map(x => x.d.split(' ')[0]),
                datasets: [{ label: 'Nivel', data: chartData.map(x => x.l), borderColor: '#3498db', fill: true, tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function downloadCSV() {
        const h = JSON.parse(localStorage.getItem('h')) || [];
        let csv = "Fecha,Paciente,Nivel\n" + h.map(x => `${x.d},${x.n},${x.l}`).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "terapia.csv";
        a.click();
    }
</script>
</body>
</html>
