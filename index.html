<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terapia Visual Avanzada - Memoria Secuencial</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #3498db; --success: #27ae60; --error: #e74c3c; 
            --bg: #f0f3f5; --text-color: #2c3e50;
            --contrast-level: 1; /* Variable para controlar el contraste */
        }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: var(--bg); margin: 0; padding: 10px; }
        #game-container { 
            width: 95vw; max-width: 600px; margin: auto; background: white; 
            padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            box-sizing: border-box; position: relative; overflow: hidden;
        }

        /* Distractores */
        .distractor {
            position: absolute; background-color: rgba(189, 195, 199, 0.4); 
            border-radius: 50%; animation: float ease-in-out infinite; 
            z-index: 0; /* Asegura que est√©n detr√°s de todo */
        }
        @keyframes float {
            0% { transform: translate(0, 0); }
            25% { transform: translate(50px, -30px); }
            50% { transform: translate(0, 0); }
            75% { transform: translate(-40px, 20px); }
            100% { transform: translate(0, 0); }
        }

        /* Controles y Stats */
        .controls, .stats { 
            background: #f8f9fa; padding: 15px; border-radius: 12px; 
            margin-bottom: 15px; border: 1px solid #eee; position: relative; z-index: 1;
        }
        .stats { display: flex; justify-content: space-around; font-weight: bold; font-size: 1.2em; color: var(--text-color); }

        /* Barra de Tiempo */
        #timer-container { width: 100%; background: #eee; height: 14px; border-radius: 7px; margin-bottom: 20px; overflow: hidden; position: relative; z-index: 1;}
        #timer-bar { width: 0%; height: 100%; background: var(--error); }

        /* Grilla de Figuras */
        .grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; 
            margin: 20px 0; position: relative; z-index: 1;
        }
        .shape { 
            aspect-ratio: 1 / 1; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; border-radius: 20px; 
            transition: 0.2s; border: 5px solid transparent; position: relative;
            filter: saturate(calc(var(--contrast-level) * 100%)) brightness(calc(var(--contrast-level) * 100%));
        }
        .active { transform: scale(0.92); border-color: #333; opacity: 0.8; box-shadow: 0 0 30px rgba(0,0,0,0.3); }

        /* Formas Geom√©tricas */
        .circle { background-color: #ff5f5f; border-radius: 50%; }
        .square { background-color: #5fafff; }
        .tri-wrap { display: flex; justify-content: center; align-items: center; height: 100%; width: 100%; }
        .triangle-shape { width: 0; height: 0; border-left: 60px solid transparent; border-right: 60px solid transparent; border-bottom: 110px solid #5fff7f; }
        .diamond { background-color: #ffef5f; transform: rotate(45deg); width: 60%; height: 60%; }

        /* Botones y Mensajes */
        button { padding: 15px; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 12px; font-weight: bold; transition: 0.3s; margin-bottom: 5px; width: 100%; position: relative; z-index: 1; }
        #start-btn { background: var(--primary); }
        #next-btn { background: var(--success); display: none; }
        #message { font-weight:bold; margin-bottom:15px; min-height:1.2em; color:var(--text-color); font-size: 1.1em; position: relative; z-index: 1; }
        
        /* Input y Range */
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; position: relative; z-index: 1; }
        input[type="range"] { width: 100%; margin-top: 10px; position: relative; z-index: 1; }

        /* Historial y Gr√°fico */
        .history-section { margin-top: 30px; text-align: left; background: #fff; padding: 20px; border-top: 2px solid #eee; border-radius: 0 0 20px 20px; position: relative; z-index: 1;}
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85em; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: #f2f2f2; color: var(--text-color); }
        .filter-box { background: #eef7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .chart-container { width: 100%; height: 250px; margin-top: 20px; background: #fff; padding: 10px; border-radius: 10px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }

        /* Alertas de error (para falso positivo) */
        .overlay-message {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.8); color: white; font-size: 2em; 
            display: flex; justify-content: center; align-items: center; 
            z-index: 10; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .overlay-message.show { opacity: 1; pointer-events: all; }

    </style>
</head>
<body>

<div id="game-container">
    <div id="distractor-overlay"></div> <div id="overlay-feedback" class="overlay-message">¬°Espera tu turno!</div>

    <h2 style="color:var(--text-color); margin-bottom:5px;">Panel de Terapia Visual</h2>
    
    <input type="text" id="patient-name" placeholder="Nombre del Paciente" oninput="updateChart()">

    <div class="controls">
        <label>Tiempo por figura: <strong id="speed-val">1.0s</strong></label>
        <input type="range" id="speed-range" min="0.5" max="10" step="0.5" value="1" oninput="updateSpeedLabel()">
        
        <label style="margin-top:15px; display:block;">Contraste de figuras: <strong id="contrast-val">Normal</strong></label>
        <input type="range" id="contrast-range" min="0.2" max="1" step="0.05" value="1" oninput="updateContrast()">
    </div>

    <div class="stats">
        <div>Nivel Actual: <span id="level-val">1</span></div>
    </div>

    <div id="timer-container"><div id="timer-bar"></div></div>

    <div class="grid">
        <div class="shape circle" id="circle" onclick="userClick('circle')"></div>
        <div class="shape square" id="square" onclick="userClick('square')"></div>
        <div class="tri-wrap"><div class="shape triangle-shape" id="triangle" onclick="userClick('triangle')"></div></div>
        <div style="display:flex; justify-content:center; align-items:center;">
            <div class="shape diamond" id="diamond" onclick="userClick('diamond')"></div>
        </div>
    </div>

    <div id="message" style="font-weight:bold; margin-bottom:15px; min-height:1.2em;">Indique nombre y presione Iniciar</div>
    
    <button id="start-btn" onclick="initGame()">Iniciar Entrenamiento</button>
    <button id="next-btn" onclick="startNextLevel()">Siguiente Nivel ‚ûî</button>

    <div class="history-section">
        <h3>Historial de Avance</h3>
        
        <div class="filter-box">
            <label>üîç Buscar Paciente:</label>
            <input type="text" id="search-input" placeholder="Escribe nombre para filtrar..." oninput="displayHistory(); updateChart();">
        </div>

        <table id="history-table">
            <thead>
                <tr>
                    <th>Paciente</th>
                    <th>Fecha</th>
                    <th>Nivel</th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>
        
        <div class="chart-container">
            <canvas id="levelChart"></canvas>
        </div>

        <div style="display: flex; gap: 5px; margin-top: 15px;">
            <button onclick="downloadCSV()" style="background:#34495e; flex:1; font-size:12px; padding:10px;">Descargar Excel (CSV)</button>
            <button onclick="clearHistory()" style="background:#95a5a6; flex:1; font-size:12px; padding:10px;">Borrar Todo</button>
        </div>
    </div>
</div>

<script>
    let sequence = [];
    let userSequence = [];
    let level = 1;
    let canClick = false;
    let currentFlashTimeout; // Para controlar el falso positivo
    let distractorInterval; // Para los distractores
    const shapes = ['circle', 'square', 'triangle', 'diamond'];
    const overlayFeedback = document.getElementById('overlay-feedback');

    // Inicializaci√≥n del gr√°fico
    let levelChart;
    const ctx = document.getElementById('levelChart').getContext('2d');
    
    window.onload = function() {
        displayHistory();
        updateContrast(); // Asegura que el contraste inicial sea 1 (normal)
        updateChart(); // Carga el gr√°fico al inicio
    };

    function updateSpeedLabel() {
        document.getElementById('speed-val').innerText = parseFloat(document.getElementById('speed-range').value).toFixed(1) + "s";
    }

    function updateContrast() {
        const contrastValue = parseFloat(document.getElementById('contrast-range').value);
        document.documentElement.style.setProperty('--contrast-level', contrastValue);
        document.getElementById('contrast-val').innerText = contrastValue === 1 ? 'Normal' : (contrastValue * 100).toFixed(0) + '%';
    }

    function initGame() {
        if (!document.getElementById('patient-name').value) {
            alert("Escribe el nombre del paciente para registrar su avance.");
            return;
        }
        level = 1;
        sequence = [];
        document.getElementById('start-btn').style.display = 'none';
        startNextLevel();
    }

    async function startNextLevel() {
        stopDistractors(); // Detener distractores para la secuencia de flash
        userSequence = [];
        canClick = false;
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('level-val').innerText = level;
        document.getElementById('message').innerText = "Memoriza...";
        sequence.push(shapes[Math.floor(Math.random() * shapes.length)]);
        await wait(600);
        const speed = parseFloat(document.getElementById('speed-range').value) * 1000;
        for (let i = 0; i < sequence.length; i++) { 
            document.getElementById('message').innerText = `Observando... (${i+1}/${sequence.length})`;
            await flash(sequence[i], speed); 
            if (overlayFeedback.classList.contains('show')) { // Si se activ√≥ el falso positivo, abortar secuencia
                resetGame();
                return;
            }
        }
        document.getElementById('message').innerText = "¬°Tu turno!";
        canClick = true;
        startDistractors(); // Reanudar distractores
    }

    function flash(id, duration) {
        return new Promise(resolve => {
            const el = document.getElementById(id);
            const bar = document.getElementById('timer-bar');
            bar.style.transition = 'none'; bar.style.width = '100%';
            void bar.offsetWidth; 
            el.classList.add('active');
            bar.style.transition = `width ${duration}ms linear`; bar.style.width = '0%';
            currentFlashTimeout = setTimeout(() => { // Guardar el timeout para el falso positivo
                el.classList.remove('active'); 
                resolve(); 
            }, duration);
        });
    }

    function userClick(id) {
        if (!canClick) { // Falso positivo
            showOverlayFeedback("¬°Espera tu turno!");
            // Si el falso positivo ocurre durante el flash, cancelamos el flash actual
            if (currentFlashTimeout) clearTimeout(currentFlashTimeout);
            resetGame(); // Reiniciar el juego por falso positivo
            return; 
        }
        
        userSequence.push(id);
        document.getElementById(id).classList.add('active');
        setTimeout(() => document.getElementById(id).classList.remove('active'), 150);

        if (userSequence[userSequence.length - 1] !== sequence[userSequence.length - 1]) {
            saveRecord();
            document.getElementById('message').innerText = "¬°Incorrecto! Sesi√≥n guardada.";
            resetGame();
            return;
        }

        if (userSequence.length === sequence.length) {
            canClick = false;
            document.getElementById('message').innerText = "¬°Correcto!";
            level++;
            document.getElementById('next-btn').style.display = 'block';
            stopDistractors(); // Detenerlos mientras esperan el siguiente nivel
        }
    }

    function resetGame() {
        stopDistractors();
        level = 1;
        sequence = [];
        canClick = false;
        document.getElementById('start-btn').style.display = 'block';
        document.getElementById('start-btn').innerText = "Reiniciar Terapia";
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('level-val').innerText = 1;
        updateChart(); // Actualiza el gr√°fico con el √∫ltimo intento
    }

    function showOverlayFeedback(message) {
        overlayFeedback.innerText = message;
        overlayFeedback.classList.add('show');
        setTimeout(() => {
            overlayFeedback.classList.remove('show');
        }, 1200);
    }

    function saveRecord() {
        const name = document.getElementById('patient-name').value;
        const date = new Date().toLocaleString();
        const record = { name, date, level: level - 1 };
        let history = JSON.parse(localStorage.getItem('therapyHistory')) || [];
        history.unshift(record);
        localStorage.setItem('therapyHistory', JSON.stringify(history));
        displayHistory();
        updateChart();
    }

    function displayHistory() {
        const history = JSON.parse(localStorage.getItem('therapyHistory')) || [];
        const filter = document.getElementById('search-input').value.toLowerCase();
        const body = document.getElementById('history-body');
        body.innerHTML = "";
        history.filter(h => h.name.toLowerCase().includes(filter)).forEach(h => {
            body.innerHTML += `<tr><td>${h.name}</td><td>${h.date.split(',')[0]}</td><td>${h.level}</td></tr>`;
        });
    }

    function downloadCSV() {
        const history = JSON.parse(localStorage.getItem('therapyHistory')) || [];
        let csv = "Paciente,Fecha,Nivel\n";
        history.forEach(h => { csv += `${h.name},"${h.date.replace(/,/g, '')}",${h.level}\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'historial_terapia.csv');
        a.click();
    }

    function clearHistory() { 
        if(confirm("¬øBorrar todo el historial de todos los pacientes?")) { 
            localStorage.removeItem('therapyHistory'); 
            displayHistory(); 
            updateChart();
        } 
    }

    // --- Funciones para Distractores ---
    function createDistractor() {
        const container = document.getElementById('game-container');
        const distractor = document.createElement('div');
        distractor.classList.add('distractor');
        const size = Math.random() * 20 + 10; // Tama√±o entre 10 y 30px
        distractor.style.width = `${size}px`;
        distractor.style.height = `${size}px`;
        distractor.style.left = `${Math.random() * 90}%`;
        distractor.style.top = `${Math.random() * 90}%`;
        distractor.style.animationDuration = `${Math.random() * 5 + 5}s`; // Duraci√≥n de animaci√≥n entre 5 y 10s
        container.appendChild(distractor);

        // Remover despu√©s de un tiempo para no acumular demasiados
        setTimeout(() => distractor.remove(), 10000); 
    }

    function startDistractors() {
        stopDistractors(); // Asegurarse de que no haya m√∫ltiples intervalos
        // Creamos un distractor cada segundo, el n√∫mero de distractores activos depender√° de su tiempo de vida
        distractorInterval = setInterval(() => {
            // Solo creamos distractores si el nivel es mayor a 3 para evitar saturar al inicio
            if (level > 3) { 
                for(let i=0; i < (level - 3); i++) { // M√°s distractores cuanto m√°s alto el nivel
                    createDistractor();
                }
            }
        }, 1500); // Crea un grupo de distractores cada 1.5 segundos
    }

    function stopDistractors() {
        clearInterval(distractorInterval);
        document.querySelectorAll('.distractor').forEach(d => d.remove());
    }

    // --- Funciones del Gr√°fico ---
    function updateChart() {
        const history = JSON.parse(localStorage.getItem('therapyHistory')) || [];
        const patientName = document.getElementById('patient-name').value.toLowerCase();
        
        // Filtra el historial para el paciente actual (si hay nombre) o el buscado
        const filteredHistory = history.filter(h => 
            (patientName && h.name.toLowerCase().includes(patientName)) ||
            (document.getElementById('search-input').value.toLowerCase() && h.name.toLowerCase().includes(document.getElementById('search-input').value.toLowerCase()))
        ).sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()); // Ordenar por fecha

        const dates = filteredHistory.map(h => new Date(h.date).toLocaleDateString('es-ES', { month: 'numeric', day: 'numeric' }));
        const levels = filteredHistory.map(h => h.level);

        if (levelChart) {
            levelChart.destroy();
        }

        levelChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Nivel Alcanzado',
                    data: levels,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false,
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(75, 192, 192)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Nivel'
                        },
                        ticks: {
                            stepSize: 1 
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Sesi√≥n'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Evoluci√≥n del Paciente'
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
</script>
</body>
</html>